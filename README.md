# Beda Backend
<a href="https://github.com/psf/black"><img alt="Code style: black" src="https://img.shields.io/badge/code%20style-black-000000.svg"></a>

В этом репозитории находится исходный код API приложения для контроля веса,
разработанного командой Solaris в рамках московской предпрофессиональной
олимпиады.

## Установка
Убедитесь, что в вашей системе присутствуют:
* [Python 3.8+](https://python.org/)
* [poetry](https://python-poetry.org/)

Создайте виртуальное окружение и установите зависимости при помощи `poetry`:

`$ poetry install`

Задайте переменные среды (см. Параметры).

Запустите сервер при комощи `uvicorn`:

`$ uvicorn app:app`

## Параметры
Сервер настраивается при помощи следующих переменных среды:

| Переменная среды | Описание                                                                                                                     | Значение по умолчанию                                                                                        |
| ---------------- | ---------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------ |
| `JWT_SECRET_KEY` | Секретный ключ, которым будут подписываться токены пользователей, рекомендуется генерировать командой `openssl rand -hex 32` | Настоятельно рекомендуется не использовать ключ по умолчанию                                                 |
| `TORTOISE_URI`   | URI базы данных для Tortoise. Может быть любым подходящим для данной библиотеки.                                             | `sqlite://:memory:` (база данных находится в оперативной памяти и не сохраняется при перезапуске приложения) |
| `CORS_ORIGINS`   | Список доменов для CORS. Этот параметр предназначен для тестирования, в продакшене CORS запрещен (`[]`).                     | `["http://localhost:3000", "http://localhost"]`                                                              |

## Запуск в docker
Вы можете собрать и запустить свой контейнер из исходников:

`$ docker build -t beda-backend .`

`$ docker run -p 80:80 -e JWT_SECRET_KEY=<...> beda-backend`

Или использовать собранный нами образ:

`$ docker pull docker.pkg.github.com/beda-app/beda-backend/beda-backend:0.1.0`

`$ docker run -p 80:80 -e JWT_SECRET_KEY=<...> docker.pkg.github.com/beda-app/beda-backend/beda-backend:0.1.0`

## Описание методов API
### POST /auth/register
Регистрирует нового пользователя.

Принимает параметры в JSON:

| Параметр | Тип данных | Описание            |
| -------- | ---------- | ------------------- |
| email    | `str`      | EMail пользователя  |
| password | `str`      | Пароль пользователя |

При успешном выполнении возвращает JSON:

| Параметр | Тип данных | Описание                                              |
| -------- | ---------- | ----------------------------------------------------- |
| token    | `str`      | Токен созданного пользователя для дальнейших запросов |

### POST /auth/login
Выпускает новый токен.

Принимает параметры в JSON:

| Параметр | Тип данных | Описание            |
| -------- | ---------- | ------------------- |
| email    | `str`      | EMail пользователя  |
| password | `str`      | Пароль пользователя |

При успешном выполнении возвращает JSON:

| Параметр | Тип данных | Описание                                   |
| -------- | ---------- | ------------------------------------------ |
| token    | `str`      | Токен пользователя для дальнейших запросов |

### POST /weight/add
Сохраняет запись о весе.

Принимает параметры в JSON:

| Параметр  | Тип данных          | Описание                                                    |
| --------- | ------------------- | ----------------------------------------------------------- |
| token     | `str`               | Токен пользователя                                          |
| weight    | `int` (1-1000)      | Вес пользователя в килограммах                              |
| timestamp | `int` (опционально) | Время в формате UNIX, по умолчанию текущее серверное время. |

При успешном выполнении возвращает JSON:

| Параметр | Тип данных | Описание                    |
| -------- | ---------- | --------------------------- |
| id       | `int`      | ID записи в базе данных     |
| weight   | `int`      | Записанный вес пользователя |
| time     | `int`      | Время в формате UNIX        |

### POST /weight/get
Возвращает список записей о весе.

Принимает параметры в JSON:

| Параметр  | Тип данных          | Описание                                                                                                                             |
| --------- | ------------------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| token     | `str`               | Токен пользователя                                                                                                                   |
| from_time | `int`               | Время в формате UNIX, начиная с которого следует возвращать записи.                                                                  |
| to_time   | `int`               | Время в формате UNIX, до которого следует возвращать записи.                                                                         |
| count     | `int` (1-200)       | Количество записей, которые нужно вернуть                                                                                            |
| offset    | `int` (опционально) | При запросе будут  переданы записи начиная с значения данного параметра. Нужно, когда получить все записи за один запрос невозможно. |

При успешном выполнении возвращает JSON:

| Параметр            | Тип данных   | Описание                                                    |
| ------------------- | ------------ | ----------------------------------------------------------- |
| count               | `int`        | Общее количество записей подходящих под текущий запрос.     |
| weights             | `list`       | Список записей                                              |
| weights[...].id     | `int`        | ID записи в базе данных                                     |
| weights[...].weight | `int`        | Записанный вес пользователя                                 |
| weights[...].time   | `int`        | Время в формате UNIX                                        |
